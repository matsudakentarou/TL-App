{% extends "app/base.html" %} {% block content %}

<div id="posts">
  <div class="imgs">
    <div class="img"></div>
  </div>
  <div class="line">
    <p>1997</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<div id="posts">
  <div class="imgs">
    <div class="img"></div>
    <div class="img"></div>
    <div class="img"></div>
  </div>
  <div class="line">
    <p>1998</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<div id="posts">
  <div class="imgs">
    <div class="img"></div>
    <div class="img"></div>
  </div>
  <div class="line">
    <p>1999</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<div id="posts">
  <div class="imgs">
    <div class="img"></div>
  </div>
  <div class="line">
    <p>2000</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<div id="posts">
  <div class="imgs">
    <div class="img"></div>
  </div>
  <div class="line">
    <p>2001</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<div id="posts">
  <div class="imgs">
    <div class="img"></div>
    <div class="img"></div>

  </div>
  <div class="line">
    <p>2002</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<div id="posts">
  <div class="imgs">
    <div class="img"></div>
    <div class="img"></div>
  </div>
  <div class="line">
    <p>2003</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<div id="posts">
  <div class="imgs">
    <div class="img"></div>
  </div>
  <div class="line">
    <p>1997</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
<div id="posts">
  <div class="imgs">
    
    <div class="img"></div>
    <div class="img"></div>
  </div>
  <div class="line">
    <p>1997</p>
  </div>
  {% for tle in tle_data %}
  
  <div class="mb-3">
    <div class="card">
      <div class="card-body">{{ tle.title }}</div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %} {% block extrajs %}
<script>
  // https://developer.mozilla.org/ja/docs/Learn/JavaScript/Client-side_web_APIs/Fetching_data

  // CSRF対策
  const getCookie = (name) => {
    if (document.cookie && document.cookie !== '') {
      for (const cookie of document.cookie.split(';')) {
        const [key, value] = cookie.trim().split('=')
        if (key === name) {
          return decodeURIComponent(value)
        }
      }
    }
  }
  const csrftoken = getCookie('csrftoken')

  // 記事追加
  const addTLE = document.getElementById('add_tle')
  addTLE.addEventListener('submit', (e) => {
    e.preventDefault()
    const url = '{% url "add" %}'
    const post_title = document.getElementById('post_title')
    // URLのクエリパラメータを管理
    const body = new URLSearchParams()
    body.append('title', post_title.value)

    fetch(url, {
      method: 'POST',
      body: body,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
        'X-CSRFToken': csrftoken,
      },
    })
      .then((response) => {
        // JSON形式に変換
        return response.json()
      })
      .then((response) => {
        // フォームをクリア
        post_title.value = ''
        // 追加するエレメント
        const postArea = document.getElementById('posts')
        const element = Object.assign(document.createElement('div'), { className: 'col-4 mb-3' })
        const element2 = Object.assign(document.createElement('div'), { className: 'card' })
        const element3 = Object.assign(document.createElement('div'), {
          className: 'card-body',
          textContent: response.title,
        })
        element.appendChild(element2)
        element2.appendChild(element3)
        // 最後に追加
        postArea.insertBefore(element, postArea.lastChild.nextSibling)
      })
      .catch((error) => {
        console.log(error)
      })
  })

  // 記事検索
  const searchTLE = document.getElementById('search_tle')
  searchTLE.addEventListener('submit', (e) => {
    e.preventDefault()
    const url = '{% url "search" %}'
    const search_title = document.getElementById('search_title')
    // URLのクエリパラメータを管理
    const body = new URLSearchParams()
    body.append('title', search_title.value)

    fetch(url, {
      method: 'POST',
      body: body,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
        'X-CSRFToken': csrftoken,
      },
    })
      .then((response) => {
        // JSON形式に変換
        return response.json()
      })
      .then((response) => {
        // フォームをクリア
        search_title.value = ''
        // 検索するエレメント
        const postArea = document.getElementById('posts')
        postArea.innerHTML = ''
        for (const title of response.title_list) {
          const element = Object.assign(document.createElement('div'), { className: 'col-4 mb-3' })
          const element2 = Object.assign(document.createElement('div'), { className: 'card' })
          const element3 = Object.assign(document.createElement('div'), {
            className: 'card-body',
            textContent: title,
          })
          element.appendChild(element2)
          element2.appendChild(element3)
          postArea.appendChild(element)
        }
      })
      .catch((error) => {
        console.log(error)
      })
  })
</script>
{% endblock %}